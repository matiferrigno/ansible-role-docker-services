# Generated by Ansible
#   role: matiferrigno.docker-services

networks:
  {{ docker_services_proxy_network }}:
    external: true
    name: {{ docker_services_proxy_network }}

services:
{% for i in item.ingress | default([]) %}
  {{ i.service }}:
    networks:
      - {{ docker_services_proxy_network }}
    labels:
      - "traefik.enable={{ ((i.state | default('present')) == 'absent') | ternary(false,true) }}"
      - "traefik.docker.network={{ docker_services_proxy_network }}"
{% if i.state | default('present') != 'absent' -%}
{% for h in i.hosts | default([]) %}
{% if h.state | default('present') != 'absent' %}
      - "traefik.http.routers.{{ h.host | replace('.','-') }}.entrypoints={{ h.entrypoints | default(['web','websecure'] | join(',')) }}"
      - "traefik.http.routers.{{ h.host | replace('.','-') }}.rule=Host(`{{ h.host }}`)"
      - "traefik.http.routers.{{ h.host | replace('.','-') }}.tls=true"
{% if h.certresolver | default('') != '' %}
      - "traefik.http.routers.{{ h.host | replace('.','-') }}.tls.certresolver={{ h.certresolver }}"
{% if h.certwildcard | default('') != '' %}
      - "traefik.http.routers.{{ h.host | replace('.','-') }}.tls.domains[0].main: {{ h.certwildcard }}"
      - "traefik.http.routers.{{ h.host | replace('.','-') }}.tls.domains[0].sans: *.{{ h.certwildcard }}"
{% endif %}
{% endif %}
{% for m in h.middlewares | default([]) %}
       - "traefik.http.routers.{{ h.host | replace('.','-') }}.middlewares={{ m }}"
{% endfor %}
      - "traefik.http.routers.{{ h.host | replace('.','-') }}.service={{ h.host | replace('.','-') }}"
      - "traefik.http.services.{{ h.host | replace('.','-') }}.loadbalancer.server.port={{ h.port | default(80) }}"
{% endif %}
{% endfor -%}
{% endif %}
{% endfor %}
