---

- name: Create reverse-proxy
  include_tasks: service.yml
  loop:
    - name: reverse-proxy
      perform:
        - action: content
          dest: docker-compose.yml
          content: |
            # Generated by Ansible
            #   role: matiferrigno.docker-services

            version: '3'

            networks:
              {{ docker_services_proxy_network }}:
                name: {{ docker_services_proxy_network }}

            services:
              reverse-proxy:
                image: {{ docker_services_proxy_image }}
                command: {{ docker_services_proxy_command }}
                networks:
                  - {{ docker_services_proxy_network }}
                ports:
                  - "{{ docker_services_proxy_http_port }}:80"
                  - "{{ docker_services_proxy_https_port }}:443"
                  - "{{ docker_services_proxy_dashboard_port }}:8080"
            {% for port in docker_services_proxy_extra_ports %}
                  - "{{ port }}:{{ port }}"
            {% endfor %}
                volumes:
                  - {{ docker_services_docker_sock }}:/var/run/docker.sock
            {% for volume in docker_services_proxy_extra_volume %}
                  - "{{ volume }}"
            {% endfor %}
            labels:
              - "traefik.http.routers.traefik.entrypoints={{ h.entrypoints | default(['web','websecure'] | join(',')) }}"
              - "traefik.http.middlewares.redirect-to-https.redirectscheme.scheme=https"
              - "traefik.http.routers.traefik.rule=hostregexp(`{host:.+}`)"
              - "traefik.http.routers.traefik.middlewares=redirect-to-https"
